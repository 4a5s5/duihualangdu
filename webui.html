<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ğŸ™ï¸ AIè¯­éŸ³åŠ©æ‰‹ | æ™ºèƒ½å¯¹è¯+TTSæœåŠ¡ (v4.0)</title>
  <style>
    :root {
      --primary-color: #667eea;
      --primary-dark: #5a67d8;
      --secondary-color: #f093fb;
      --success-color: #48bb78;
      --error-color: #f56565;
      --warning-color: #ed8936;
      --light-gray: #f7fafc;
      --gray: #718096;
      --border-color: #e2e8f0;
      --text-color: #2d3748;
      --text-light: #4a5568;

      /* æ–°çš„æ¸å˜è‰²å½©æ–¹æ¡ˆ */
      --gradient-start: #ff9a9e;
      --gradient-middle: #fecfef;
      --gradient-end: #fecfef;
      --gradient-accent: #a8edea;

      /* å¡ç‰‡å’Œé¢æ¿é¢œè‰² */
      --card-bg: rgba(255, 255, 255, 0.95);
      --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      --card-shadow-hover: 0 15px 35px rgba(0, 0, 0, 0.15);

      /* æŒ‰é’®æ¸å˜ */
      --btn-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --btn-gradient-hover: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
      --btn-success-gradient: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      --btn-warning-gradient: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
    }

    * {
      box-sizing: border-box;
    }

    html {
      padding: 0;
      margin: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      position: relative;
    }

    /* æ·»åŠ èƒŒæ™¯è£…é¥° */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    [v-cloak] {
      display: none;
    }

    .app-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 1rem 0 2rem;
    }

    .container {
      max-width: 1200px;
      width: 100%;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      padding: 2.5rem;
      border-radius: 24px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 50%, #a8edea 100%);
      border-radius: 24px 24px 0 0;
    }

    /* æ¨¡å¼åˆ‡æ¢æ ·å¼ */
    .mode-toggle {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .mode-toggle .btn-group {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border-radius: 50px;
      overflow: hidden;
      padding: 4px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .mode-toggle .btn {
      padding: 1rem 2.5rem;
      font-weight: 600;
      border: none;
      border-radius: 46px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      font-size: 0.95rem;
    }

    .mode-toggle .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.5s;
    }

    .mode-toggle .btn:hover::before {
      left: 100%;
    }

    .mode-toggle .btn.active {
      background: var(--btn-gradient);
      color: white;
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .mode-toggle .btn:not(.active) {
      background: transparent;
      color: var(--text-color);
    }

    .mode-toggle .btn:not(.active):hover {
      background: rgba(255, 255, 255, 0.6);
      transform: translateY(-1px);
    }

    /* AIå¯¹è¯æ¨¡å¼æ ·å¼ */
    .chat-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      height: 70vh;
    }

    .chat-area {
      display: flex;
      flex-direction: column;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }

    .chat-header {
      background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      color: white;
      padding: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .chat-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .chat-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }

    .chat-header .btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 8px;
      padding: 0.4rem 0.8rem;
      margin-left: 0.5rem;
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
    }

    .chat-header .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      position: relative;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 3px;
    }

    .message {
      margin-bottom: 1.5rem;
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-content {
      max-width: 75%;
      padding: 1rem 1.2rem;
      border-radius: 18px;
      position: relative;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 6px;
    }

    .message.ai .message-content {
      background: rgba(255, 255, 255, 0.95);
      color: var(--text-color);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-bottom-left-radius: 6px;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .message.ai .message-avatar {
      background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      color: white;
    }

    .message-controls {
      margin-top: 0.8rem;
      display: flex;
      gap: 0.5rem;
    }

    .message-controls .btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .message-controls .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .chat-input-area {
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.95);
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }

    .chat-input-area .input-group {
      align-items: flex-end;
      display: flex;
      gap: 1rem;
    }

    .chat-input-area textarea {
      flex: 1;
      resize: none;
      border-radius: 20px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      padding: 1rem 1.2rem;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    .chat-input-area textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      outline: none;
    }

    .chat-input-area .btn {
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--btn-gradient);
      border: none;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .chat-input-area .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    /* è¯­éŸ³æ§åˆ¶é¢æ¿æ ·å¼ */
    .voice-control-panel {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      padding: 2rem;
      height: fit-content;
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .voice-control-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%);
      border-radius: 20px 20px 0 0;
    }

    .voice-control-panel h3 {
      color: var(--text-color);
      margin-bottom: 1.5rem;
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .voice-control-panel h3 i {
      color: #ff6b6b;
    }

    .voice-control-panel.with-debug {
      height: 50vh;
      overflow-y: auto;
    }

    /* Vue.js cloak */
    [v-cloak] {
      display: none;
    }

    /* è°ƒè¯•é¢æ¿æ ·å¼ */
    .debug-panel {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
      animation: slideInDown 0.3s ease-out;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .debug-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
      border-radius: 20px 20px 0 0;
    }

    .debug-panel h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--text-color);
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .debug-panel h3 i {
      color: #f59e0b;
    }

    .debug-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .debug-logs {
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      padding: 1rem;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .debug-logs::-webkit-scrollbar {
      width: 6px;
    }

    .debug-logs::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    .debug-logs::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      border-radius: 3px;
    }

    .debug-log-item {
      margin-bottom: 1rem;
      padding: 0.8rem;
      border-radius: 8px;
      border-left: 4px solid #6b7280;
      background: rgba(255, 255, 255, 0.7);
    }

    .debug-log-item.log-info {
      border-left-color: #3b82f6;
      background: rgba(219, 234, 254, 0.5);
    }

    .debug-log-item.log-success {
      border-left-color: #10b981;
      background: rgba(220, 252, 231, 0.5);
    }

    .debug-log-item.log-error {
      border-left-color: #ef4444;
      background: rgba(254, 226, 226, 0.5);
    }

    .debug-log-item.log-warning {
      border-left-color: #f59e0b;
      background: rgba(254, 243, 199, 0.5);
    }

    .log-time {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.3rem;
    }

    .log-content {
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .log-data {
      background: rgba(0, 0, 0, 0.8);
      color: #10b981;
      padding: 0.8rem;
      border-radius: 6px;
      overflow-x: auto;
    }

    .log-data pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .no-logs {
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 2rem;
    }

    .audio-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .audio-controls .btn {
      padding: 0.6rem;
      font-size: 0.85rem;
      border-radius: 8px;
    }

    /* TTSæ¨¡å¼æ ·å¼è°ƒæ•´ */
    .tts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .tts-form-card, .tts-result-card {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      padding: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .tts-form-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px 20px 0 0;
    }

    .tts-result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #ff6b6b 0%, #feca57 100%);
      border-radius: 20px 20px 0 0;
    }

    .tts-form-card h3, .tts-result-card h3 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--text-color);
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tts-form-card h3 i {
      color: #667eea;
    }

    .tts-result-card h3 i {
      color: #ff6b6b;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading-message {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--gray);
      font-style: italic;
    }

    .loading-message .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .chat-container, .tts-container {
        grid-template-columns: 1fr;
        height: auto;
      }
      
      .chat-area {
        height: 60vh;
      }
      
      .mode-toggle .btn {
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
      }
    }

    h1 {
      text-align: center;
      color: var(--text-color);
      margin-bottom: 2.5rem;
      font-weight: 700;
      font-size: 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ff6b6b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      padding-bottom: 1rem;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #ff6b6b 100%);
      border-radius: 2px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 1rem 1.2rem;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    .textarea-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.5rem;
    }

    .clear-btn {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .clear-btn:hover {
      background-color: rgba(79, 70, 229, 0.1);
    }

    .label-with-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .pause-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .pause-input {
      width: 6.5em;
      padding: 0.4rem 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.9rem;
      text-align: center;
    }

    .pause-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
    }

    .btn-insert-pause {
      background: linear-gradient(135deg, #6ee7b7, #10b981);
      color: white;
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-insert-pause:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    }

    .btn-insert-pause:active {
      transform: scale(0.95);
    }

    /* AIè®¾ç½®ç•Œé¢ç‰¹æ®Šæ ·å¼ */
    .label-with-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .label-with-controls label {
      margin-bottom: 0;
      flex: 1;
    }

    .btn-outline-primary {
      background: rgba(102, 126, 234, 0.1);
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      box-shadow: none;
    }

    .btn-outline-primary:hover {
      background: var(--primary-color);
      color: white;
    }

    .btn-outline-primary:disabled {
      background: rgba(102, 126, 234, 0.05);
      color: rgba(102, 126, 234, 0.5);
      border-color: rgba(102, 126, 234, 0.3);
      cursor: not-allowed;
      transform: none !important;
    }

    .fa-spin {
      animation: fa-spin 1s infinite linear;
    }

    @keyframes fa-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡†æ ·å¼ */
    select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
      appearance: none;
    }

    select:focus {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23667eea' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    }

    /* æµ‹è¯•æŒ‰é’®æ ·å¼ */
    .test-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .btn-outline-success {
      background: rgba(72, 187, 120, 0.1);
      color: var(--success-color);
      border: 1px solid var(--success-color);
      box-shadow: none;
    }

    .btn-outline-success:hover {
      background: var(--success-color);
      color: white;
    }

    .btn-outline-success:disabled {
      background: rgba(72, 187, 120, 0.05);
      color: rgba(72, 187, 120, 0.5);
      border-color: rgba(72, 187, 120, 0.3);
      cursor: not-allowed;
      transform: none !important;
    }

    .grid-layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .slider-group input[type="range"] {
      flex-grow: 1;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      position: relative;
    }

    .slider-group input[type="range"]::-webkit-slider-track {
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
    }

    .slider-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
    }

    .slider-group input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .slider-group input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
    }

    .slider-group input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .slider-group span {
      font-weight: 600;
      min-width: 60px;
      text-align: right;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 0.95rem;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .button-group .btn {
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 16px;
      position: relative;
      overflow: hidden;
    }

    .button-group .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }

    .button-group .btn-success {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.3);
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-generate {
      background: linear-gradient(135deg, var(--gray), #475569);
      color: white;
    }

    .btn-stream {
      background: linear-gradient(135deg, var(--success-color), #16a34a);
      color: white;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .status {
      margin-top: 1.5rem;
      padding: 1.2rem;
      border-radius: 16px;
      text-align: center;
      font-weight: 500;
      display: none;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      animation: slideInUp 0.3s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .status.show {
      display: block;
    }

    .status-info {
      background: linear-gradient(135deg, rgba(219, 234, 254, 0.9) 0%, rgba(147, 197, 253, 0.9) 100%);
      color: #1d4ed8;
      border: 1px solid rgba(147, 197, 253, 0.5);
    }

    .status-success {
      background: linear-gradient(135deg, rgba(220, 252, 231, 0.9) 0%, rgba(134, 239, 172, 0.9) 100%);
      color: #166534;
      border: 1px solid rgba(134, 239, 172, 0.5);
    }

    .status-error {
      background: linear-gradient(135deg, rgba(254, 226, 226, 0.9) 0%, rgba(252, 165, 165, 0.9) 100%);
      color: #dc2626;
      border: 1px solid rgba(252, 165, 165, 0.5);
    }

    audio {
      width: 100%;
      margin-top: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }

    .download-section {
      margin-top: 1.5rem;
      text-align: center;
    }

    .btn-download {
      background: var(--btn-warning-gradient);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.8rem;
      box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn-download::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-download:hover::before {
      left: 100%;
    }

    .btn-download:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(237, 137, 54, 0.4);
    }

    .btn-download:active {
      transform: scale(0.98);
    }

    details {
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    details:hover {
      border-color: rgba(102, 126, 234, 0.4);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    details[open] {
      border-color: var(--primary-color);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    summary {
      font-weight: 600;
      cursor: pointer;
      color: var(--text-color);
      padding: 0.8rem 0;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: color 0.3s ease;
    }

    summary:hover {
      color: var(--primary-color);
    }

    summary::marker {
      color: var(--primary-color);
    }

    .checkbox-grid {
      margin-top: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(102, 126, 234, 0.1);
      transition: all 0.3s ease;
    }

    .checkbox-item:hover {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(102, 126, 234, 0.3);
      transform: translateY(-1px);
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      accent-color: var(--primary-color);
      cursor: pointer;
    }

    .checkbox-item label {
      margin: 0;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-color);
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }

      .app-container {
        padding: 0 0 1rem;
      }

      .container {
        padding: 1.5rem;
        border-radius: 12px;
      }

      h1 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .grid-layout {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .button-group {
        grid-template-columns: 1fr;
      }

      .checkbox-grid {
        grid-template-columns: 1fr;
      }

      .slider-group span {
        min-width: 45px;
        font-size: 0.85rem;
      }

      textarea {
        min-height: 100px;
      }

      .label-with-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .pause-controls {
        align-self: flex-end;
      }

      .pause-input {
        font-size: 0.85rem;
      }

      .btn-insert-pause {
        font-size: 0.8rem;
        padding: 0.35rem 0.7rem;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 1rem;
        margin: 0.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      input[type="text"],
      input[type="password"],
      select,
      textarea {
        padding: 0.7rem;
        font-size: 16px;
        /* é˜²æ­¢iOSç¼©æ”¾ */
      }

      .slider-group {
        gap: 0.5rem;
      }
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal-dialog {
      max-width: 650px;
      width: 90%;
      margin: 0 auto;
      animation: slideInDown 0.3s ease-out;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(20px);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .modal-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 3s infinite;
    }

    .modal-header h5 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: white;
      position: relative;
      z-index: 1;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      width: 32px;
      height: 32px;
      font-size: 1.2rem;
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .modal-body {
      padding: 2rem;
      max-height: 70vh;
      overflow-y: auto;
    }

    .modal-body::-webkit-scrollbar {
      width: 6px;
    }

    .modal-body::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    .modal-body::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 3px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      padding: 1.5rem 2rem;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(248, 250, 252, 0.8);
      backdrop-filter: blur(10px);
    }

    /* é€šç”¨æŒ‰é’®æ ·å¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--btn-gradient);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
    }

    .btn-success {
      background: var(--btn-success-gradient);
      color: white;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
    }

    .btn-warning {
      background: var(--btn-warning-gradient);
      color: white;
      box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(237, 137, 54, 0.4);
    }

    .btn-outline {
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      border-radius: 8px;
    }

    .btn-lg {
      padding: 1rem 2rem;
      font-size: 1.1rem;
      border-radius: 16px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .btn:disabled::before {
      display: none;
    }

    .help-text {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.25rem;
    }
  </style>
</head>

<body>
  <div id="app" class="app-container">
    <main class="container">
      <h1 v-cloak>{{ title }}</h1>

      <!-- æ¨¡å¼åˆ‡æ¢ -->
      <div class="mode-toggle">
        <div class="btn-group" role="group">
          <button type="button" 
                  class="btn" 
                  :class="{ active: currentMode === 'chat' }"
                  @click="switchMode('chat')">
            <i class="fas fa-comments"></i> AIå¯¹è¯æ¨¡å¼
          </button>
          <button type="button" 
                  class="btn" 
                  :class="{ active: currentMode === 'tts' }"
                  @click="switchMode('tts')">
            <i class="fas fa-microphone"></i> TTSæ¨¡å¼
          </button>
        </div>
      </div>

      <!-- AIå¯¹è¯æ¨¡å¼ -->
      <div v-show="currentMode === 'chat'" class="chat-container">
        <!-- å¯¹è¯åŒºåŸŸ -->
        <div class="chat-area">
          <div class="chat-header">
            <h3><i class="fas fa-robot"></i> AIæ™ºèƒ½å¯¹è¯</h3>
            <div>
              <button class="btn btn-sm btn-light" @click="showAISettings = true" title="AIè®¾ç½®">
                <i class="fas fa-cog"></i>
              </button>
              <button class="btn btn-sm btn-light" @click="showDebugPanel = !showDebugPanel" title="è°ƒè¯•é¢æ¿">
                <i class="fas fa-bug"></i>
              </button>
              <button class="btn btn-sm btn-light" @click="cleanChatHistory" title="æ¸…ç†é”™è¯¯æ¶ˆæ¯">
                <i class="fas fa-broom"></i>
              </button>
              <button class="btn btn-sm btn-light" @click="clearChat" title="æ¸…ç©ºå¯¹è¯">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          
          <div class="chat-messages" ref="chatMessages">
            <div v-if="chatHistory.length === 0" class="text-center p-4">
              <i class="fas fa-robot fa-3x text-primary mb-3"></i>
              <h5>ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIè¯­éŸ³åŠ©æ‰‹ ğŸ¤–</h5>
              <p class="text-muted">æˆ‘å¯ä»¥å’Œä½ èŠå¤©ï¼Œå¹¶ä¸”ä¼šç”¨è¯­éŸ³æœ—è¯»æˆ‘çš„å›å¤å“¦ï½</p>
            </div>
            
            <div v-for="(message, index) in chatHistory" :key="index" 
                 class="message" :class="message.role">
              <div class="message-avatar">
                <i :class="message.role === 'user' ? 'fas fa-user' : 'fas fa-robot'"></i>
              </div>
              <div class="message-content">
                {{ message.content }}
                <div v-if="message.role === 'assistant'" class="message-controls">
                  <button class="btn btn-sm btn-outline-primary" 
                          @click="speakText(message.content)"
                          :disabled="isGeneratingVoice">
                    <i class="fas fa-volume-up"></i> æœ—è¯»
                  </button>
                </div>
              </div>
            </div>
            
            <div v-if="isThinking" class="message ai">
              <div class="message-avatar">
                <i class="fas fa-robot"></i>
              </div>
              <div class="message-content">
                <div class="loading-message">
                  <div class="spinner"></div>
                  AIæ­£åœ¨æ€è€ƒä¸­...
                </div>
              </div>
            </div>
          </div>
          
          <div class="chat-input-area">
            <div class="input-group">
              <textarea v-model="chatInput"
                        @keydown.enter.exact.prevent="sendMessage()"
                        placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..."
                        rows="2"
                        :disabled="isThinking"></textarea>
              <div class="input-group-append">
                <button class="btn btn-primary"
                        @click="sendMessage()"
                        :disabled="isThinking || !chatInput.trim()">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- è°ƒè¯•é¢æ¿ -->
        <div v-show="showDebugPanel" class="debug-panel" v-cloak>
          <h3><i class="fas fa-bug"></i> è°ƒè¯•ä¿¡æ¯
            <small style="font-weight: normal; color: #6b7280;">
              ({{ debugLogs.length }} æ¡æ—¥å¿—)
            </small>
          </h3>
          <div class="debug-controls">
            <button @click="clearDebugLogs" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-trash"></i> æ¸…ç©ºæ—¥å¿—
            </button>
            <button @click="exportDebugLogs" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-download"></i> å¯¼å‡ºæ—¥å¿—
            </button>
            <button @click="showDebugPanel = false" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-times"></i> å…³é—­
            </button>
          </div>
          <div class="debug-logs" ref="debugLogs">
            <div v-for="(log, index) in debugLogs" :key="'log-' + index"
                 class="debug-log-item" :class="'log-' + log.type">
              <div class="log-time">{{ log.time }}</div>
              <div class="log-content">{{ log.message }}</div>
              <div v-if="log.data" class="log-data">
                <pre>{{ log.data }}</pre>
              </div>
            </div>
            <div v-if="debugLogs.length === 0" class="no-logs">
              <i class="fas fa-info-circle"></i> æš‚æ— è°ƒè¯•æ—¥å¿—
              <br><small>æ‰§è¡ŒAIå¯¹è¯æˆ–æµ‹è¯•åŠŸèƒ½åä¼šæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—</small>
            </div>
          </div>
        </div>

        <!-- è¯­éŸ³æ§åˆ¶é¢æ¿ -->
        <div class="voice-control-panel" :class="{ 'with-debug': showDebugPanel }">
          <h3><i class="fas fa-volume-up"></i> è¯­éŸ³æ§åˆ¶</h3>
          
          <div class="form-group">
            <label for="chatVoice">é€‰æ‹©è¯­éŸ³ï¼š</label>
            <select id="chatVoice" v-model="chatSettings.voice" class="form-control">
              <option value="zh-CN-XiaoxiaoNeural">ä¸­æ–‡å¥³å£° (æ™“æ™“)</option>
              <option value="zh-CN-YunxiNeural">ä¸­æ–‡ç”·å£° (äº‘å¸Œ)</option>
              <option value="zh-CN-YunyangNeural">ä¸­æ–‡ç”·å£° (äº‘æ‰¬)</option>
              <option value="zh-CN-XiaoyiNeural">ä¸­æ–‡å¥³å£° (æ™“ä¼Š)</option>
              <option value="zh-CN-YunjianNeural">ä¸­æ–‡ç”·å£° (äº‘å¥)</option>
              <option value="zh-CN-XiaochenNeural">ä¸­æ–‡å¥³å£° (æ™“è¾°)</option>
              <option value="zh-CN-XiaohanNeural">ä¸­æ–‡å¥³å£° (æ™“æ¶µ)</option>
              <option value="zh-CN-XiaomengNeural">ä¸­æ–‡å¥³å£° (æ™“æ¢¦)</option>
              <option value="zh-CN-XiaomoNeural">ä¸­æ–‡å¥³å£° (æ™“å¢¨)</option>
              <option value="zh-CN-XiaoqiuNeural">ä¸­æ–‡å¥³å£° (æ™“ç§‹)</option>
              <option value="zh-CN-XiaoruiNeural">ä¸­æ–‡å¥³å£° (æ™“ç¿)</option>
              <option value="zh-CN-XiaoshuangNeural">ä¸­æ–‡å¥³å£° (æ™“åŒ)</option>
              <option value="zh-CN-XiaoxuanNeural">ä¸­æ–‡å¥³å£° (æ™“è±)</option>
              <option value="zh-CN-XiaoyanNeural">ä¸­æ–‡å¥³å£° (æ™“é¢œ)</option>
              <option value="zh-CN-XiaoyouNeural">ä¸­æ–‡å¥³å£° (æ™“æ‚ )</option>
              <option value="zh-CN-XiaozhenNeural">ä¸­æ–‡å¥³å£° (æ™“ç”„)</option>
              <option value="zh-CN-YunfengNeural">ä¸­æ–‡ç”·å£° (äº‘æ«)</option>
              <option value="zh-CN-YunhaoNeural">ä¸­æ–‡ç”·å£° (äº‘çš“)</option>
              <option value="zh-CN-YunxiaNeural">ä¸­æ–‡ç”·å£° (äº‘å¤)</option>
              <option value="zh-CN-YunyeNeural">ä¸­æ–‡ç”·å£° (äº‘é‡)</option>
              <option value="zh-CN-YunzeNeural">ä¸­æ–‡ç”·å£° (äº‘æ³½)</option>
              <option value="en-US-JennyNeural">è‹±æ–‡å¥³å£° (Jenny)</option>
              <option value="en-US-GuyNeural">è‹±æ–‡ç”·å£° (Guy)</option>
              <option value="en-US-AriaNeural">è‹±æ–‡å¥³å£° (Aria)</option>
              <option value="en-US-DavisNeural">è‹±æ–‡ç”·å£° (Davis)</option>
            </select>
          </div>

          <div class="form-group">
            <label>è¯­é€Ÿ: <span>{{ chatSettings.speed.toFixed(2) }}</span></label>
            <div class="slider-group">
              <input type="range" v-model.number="chatSettings.speed" 
                     min="0.25" max="2.0" step="0.05" class="form-control-range" />
            </div>
          </div>

          <div class="form-group">
            <label>éŸ³è°ƒ: <span>{{ chatSettings.pitch.toFixed(2) }}</span></label>
            <div class="slider-group">
              <input type="range" v-model.number="chatSettings.pitch" 
                     min="0.5" max="1.5" step="0.05" class="form-control-range" />
            </div>
          </div>

          <div class="audio-controls">
            <button class="btn btn-success btn-sm" @click="playAudio" :disabled="!currentAudio">
              <i class="fas fa-play"></i> æ’­æ”¾
            </button>
            <button class="btn btn-warning btn-sm" @click="pauseAudio" :disabled="!currentAudio">
              <i class="fas fa-pause"></i> æš‚åœ
            </button>
            <button class="btn btn-danger btn-sm" @click="stopAudio" :disabled="!currentAudio">
              <i class="fas fa-stop"></i> åœæ­¢
            </button>
            <button class="btn btn-info btn-sm" @click="replayAudio" :disabled="!currentAudio">
              <i class="fas fa-redo"></i> é‡æ’­
            </button>
          </div>

          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" 
                   id="autoSpeak" v-model="chatSettings.autoSpeak">
            <label class="form-check-label" for="autoSpeak">
              è‡ªåŠ¨æœ—è¯»AIå›å¤
            </label>
          </div>
          

          <audio ref="chatAudio" style="display: none;"></audio>
        </div>
      </div>

      <!-- TTSæ¨¡å¼ -->
      <div v-show="currentMode === 'tts'" class="tts-container">
        <div class="tts-form-card">
          <h3><i class="fas fa-microphone"></i> æ–‡æœ¬è½¬è¯­éŸ³</h3>
          
          <details>
            <summary>API é…ç½®</summary>
            <div class="form-group" style="margin-top: 1rem">
              <label for="baseUrl">API Base URL</label>
              <input type="text" id="baseUrl" v-model="config.baseUrl" @input="saveConfig" placeholder="https://ä½ çš„åŸŸå" />
            </div>
            <div class="form-group" style="margin-bottom: 0">
              <label for="apiKey">API Key</label>
              <input type="password" id="apiKey" v-model="config.apiKey" @input="saveConfig" placeholder="ä½ çš„å¯†é’¥" />
            </div>
          </details>
<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ğŸ™ï¸ AIè¯­éŸ³åŠ©æ‰‹ | æ™ºèƒ½å¯¹è¯+TTSæœåŠ¡ (v4.0)</title>
  <style>
    :root {
      --primary-color: #4f46e5;
      --success-color: #22c55e;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --light-gray: #f8fafc;
      --gray: #64748b;
      --border-color: #e2e8f0;
      --text-color: #1e293b;
      --mint-start: #f0fdfa;
      --mint-middle: #e6fffa;
      --mint-end: #fdf2f8;
      --mint-accent: #6ee7b7;
    }

    * {
      box-sizing: border-box;
    }

    html {
      padding: 0;
      margin: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--mint-start) 0%, var(--mint-middle) 50%, var(--mint-end) 100%);
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }

    [v-cloak] {
      display: none;
    }

    .app-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 1rem 0 2rem;
    }

    .container {
      max-width: 1200px;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* æ¨¡å¼åˆ‡æ¢æ ·å¼ */
    .mode-toggle {
      text-align: center;
      margin-bottom: 2rem;
    }

    .mode-toggle .btn-group {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 25px;
      overflow: hidden;
    }

    .mode-toggle .btn {
      padding: 0.8rem 2rem;
      font-weight: 600;
      border: none;
      transition: all 0.3s ease;
    }

    .mode-toggle .btn.active {
      background: linear-gradient(135deg, var(--primary-color), var(--mint-accent));
      color: white;
      transform: scale(1.05);
    }

    .mode-toggle .btn:not(.active) {
      background: rgba(255, 255, 255, 0.8);
      color: var(--text-color);
    }

    /* AIå¯¹è¯æ¨¡å¼æ ·å¼ */
    .chat-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      height: 70vh;
    }

    .chat-area {
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, var(--primary-color), var(--mint-accent));
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: #f8fafc;
    }

    .message {
      margin-bottom: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-content {
      max-width: 70%;
      padding: 0.8rem 1rem;
      border-radius: 12px;
      position: relative;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, var(--primary-color), #6366f1);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.ai .message-content {
      background: white;
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 4px;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: var(--primary-color);
      color: white;
    }

    .message.ai .message-avatar {
      background: var(--mint-accent);
      color: white;
    }

    .message-controls {
      margin-top: 0.5rem;
      display: flex;
      gap: 0.5rem;
    }

    .message-controls .btn {
      padding: 0.2rem 0.5rem;
      font-size: 0.75rem;
      border-radius: 4px;
    }

    .chat-input-area {
      padding: 1rem;
      background: white;
      border-top: 1px solid var(--border-color);
    }

    .chat-input-area .input-group {
      align-items: flex-end;
    }

    .chat-input-area textarea {
      resize: none;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      padding: 0.8rem 1rem;
    }

    .chat-input-area .btn {
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 0.5rem;
    }

    /* è¯­éŸ³æ§åˆ¶é¢æ¿æ ·å¼ */
    .voice-control-panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      height: fit-content;
    }

    .voice-control-panel h3 {
      color: var(--text-color);
      margin-bottom: 1.5rem;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .audio-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .audio-controls .btn {
      padding: 0.6rem;
      font-size: 0.85rem;
      border-radius: 8px;
    }



    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .chat-container, .tts-container {
        grid-template-columns: 1fr;
        height: auto;
      }
      
      .chat-area {
        height: 60vh;
      }
      
      .mode-toggle .btn {
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
      }
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }

      .app-container {
        padding: 0 0 1rem;
      }

      .container {
        padding: 1.5rem;
        border-radius: 12px;
      }

      h1 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .grid-layout {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .button-group {
        grid-template-columns: 1fr;
      }

      .checkbox-grid {
        grid-template-columns: 1fr;
      }

      .slider-group span {
        min-width: 45px;
        font-size: 0.85rem;
      }

      textarea {
        min-height: 100px;
      }

      .label-with-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .pause-controls {
        align-self: flex-end;
      }

      .pause-input {
        font-size: 0.85rem;
      }

      .btn-insert-pause {
        font-size: 0.8rem;
        padding: 0.35rem 0.7rem;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 1rem;
        margin: 0.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      input[type="text"],
      input[type="password"],
      select,
      textarea {
        padding: 0.7rem;
        font-size: 16px;
        /* é˜²æ­¢iOSç¼©æ”¾ */
      }

      .slider-group {
        gap: 0.5rem;
      }
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>

          <div class="form-group">
            <div class="label-with-controls">
              <label for="inputText">è¾“å…¥æ–‡æœ¬</label>
              <div class="pause-controls">
                <input type="number" v-model.number="pauseTime" min="0.01" max="100" step="0.01" placeholder="åœé¡¿æ—¶é•¿"
                  class="pause-input" />
                <button type="button" @click="insertPause" class="btn-insert-pause" title="åœ¨å…‰æ ‡ä½ç½®æ’å…¥åœé¡¿">
                  æ’å…¥åœé¡¿
                </button>
              </div>
            </div>
            <textarea id="inputText" ref="textareaRef" v-model="form.inputText" @input="saveForm"
              placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥æ–‡æœ¬ï¼Œç›®å‰å°½å¯èƒ½ä¸è¦è¶…è¿‡1ç‚¹5ä¸‡å­—æ¯æ¬¡ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚éŸ³è‰²æ˜ å°„å¯ä»¥è‡ªè¡Œä¿®æ”¹workersçš„é…ç½®"></textarea>
            <div class="textarea-footer">
              <span v-cloak>{{ charCount }} å­—ç¬¦</span>
              <button class="clear-btn" @click="clearText">æ¸…é™¤</button>
            </div>
          </div>

          <div class="grid-layout">
            <div class="form-group">
              <label for="voice">é€‰æ‹©éŸ³è‰² (Model)</label>
              <select id="voice" v-model="form.voice" @change="saveForm">
                <option value="zh-CN-XiaoxiaoNeural">ä¸­æ–‡å¥³å£° (æ™“æ™“)</option>
                <option value="zh-CN-YunxiNeural">ä¸­æ–‡ç”·å£° (äº‘å¸Œ)</option>
                <option value="zh-CN-YunyangNeural">ä¸­æ–‡ç”·å£° (äº‘æ‰¬)</option>
                <option value="zh-CN-XiaoyiNeural">ä¸­æ–‡å¥³å£° (æ™“ä¼Š)</option>
                <option value="zh-CN-YunjianNeural">ä¸­æ–‡ç”·å£° (äº‘å¥)</option>
                <option value="zh-CN-XiaochenNeural">ä¸­æ–‡å¥³å£° (æ™“è¾°)</option>
                <option value="zh-CN-XiaohanNeural">ä¸­æ–‡å¥³å£° (æ™“æ¶µ)</option>
                <option value="zh-CN-XiaomengNeural">ä¸­æ–‡å¥³å£° (æ™“æ¢¦)</option>
                <option value="zh-CN-XiaomoNeural">ä¸­æ–‡å¥³å£° (æ™“å¢¨)</option>
                <option value="zh-CN-XiaoqiuNeural">ä¸­æ–‡å¥³å£° (æ™“ç§‹)</option>
                <option value="zh-CN-XiaoruiNeural">ä¸­æ–‡å¥³å£° (æ™“ç¿)</option>
                <option value="zh-CN-XiaoshuangNeural">ä¸­æ–‡å¥³å£° (æ™“åŒ)</option>
                <option value="zh-CN-XiaoxuanNeural">ä¸­æ–‡å¥³å£° (æ™“è±)</option>
                <option value="zh-CN-XiaoyanNeural">ä¸­æ–‡å¥³å£° (æ™“é¢œ)</option>
                <option value="zh-CN-XiaoyouNeural">ä¸­æ–‡å¥³å£° (æ™“æ‚ )</option>
                <option value="zh-CN-XiaozhenNeural">ä¸­æ–‡å¥³å£° (æ™“ç”„)</option>
                <option value="zh-CN-YunfengNeural">ä¸­æ–‡ç”·å£° (äº‘æ«)</option>
                <option value="zh-CN-YunhaoNeural">ä¸­æ–‡ç”·å£° (äº‘çš“)</option>
                <option value="zh-CN-YunxiaNeural">ä¸­æ–‡ç”·å£° (äº‘å¤)</option>
                <option value="zh-CN-YunyeNeural">ä¸­æ–‡ç”·å£° (äº‘é‡)</option>
                <option value="zh-CN-YunzeNeural">ä¸­æ–‡ç”·å£° (äº‘æ³½)</option>
                <option value="en-US-JennyNeural">è‹±æ–‡å¥³å£° (Jenny)</option>
                <option value="en-US-GuyNeural">è‹±æ–‡ç”·å£° (Guy)</option>
                <option value="en-US-AriaNeural">è‹±æ–‡å¥³å£° (Aria)</option>
                <option value="en-US-DavisNeural">è‹±æ–‡ç”·å£° (Davis)</option>
                <option value="en-US-AmberNeural">è‹±æ–‡å¥³å£° (Amber)</option>
                <option value="en-US-AnaNeural">è‹±æ–‡å¥³å£° (Ana)</option>
                <option value="en-US-AshleyNeural">è‹±æ–‡å¥³å£° (Ashley)</option>
                <option value="en-US-BrandonNeural">è‹±æ–‡ç”·å£° (Brandon)</option>
                <option value="en-US-ChristopherNeural">è‹±æ–‡ç”·å£° (Christopher)</option>
                <option value="en-US-CoraNeural">è‹±æ–‡å¥³å£° (Cora)</option>
                <option value="en-US-ElizabethNeural">è‹±æ–‡å¥³å£° (Elizabeth)</option>
                <option value="en-US-EricNeural">è‹±æ–‡ç”·å£° (Eric)</option>
                <option value="en-US-JacobNeural">è‹±æ–‡ç”·å£° (Jacob)</option>
                <option value="en-US-JaneNeural">è‹±æ–‡å¥³å£° (Jane)</option>
                <option value="en-US-JasonNeural">è‹±æ–‡ç”·å£° (Jason)</option>
                <option value="en-US-MichelleNeural">è‹±æ–‡å¥³å£° (Michelle)</option>
                <option value="en-US-MonicaNeural">è‹±æ–‡å¥³å£° (Monica)</option>
                <option value="en-US-NancyNeural">è‹±æ–‡å¥³å£° (Nancy)</option>
                <option value="en-US-RogerNeural">è‹±æ–‡ç”·å£° (Roger)</option>
                <option value="en-US-SaraNeural">è‹±æ–‡å¥³å£° (Sara)</option>
                <option value="en-US-SteffanNeural">è‹±æ–‡ç”·å£° (Steffan)</option>
                <option value="en-US-TonyNeural">è‹±æ–‡ç”·å£° (Tony)</option>
              </select>
            </div>
            <div class="form-group">
              <label>è¯­é€Ÿ</label>
              <div class="slider-group">
                <input type="range" v-model.number="form.speed" @input="saveForm" min="0.25" max="2.0" step="0.05" />
                <span v-cloak>{{ speedDisplay }}</span>
              </div>
            </div>
            <div class="form-group">
              <label>éŸ³è°ƒ</label>
              <div class="slider-group">
                <input type="range" v-model.number="form.pitch" @input="saveForm" min="0.5" max="1.5" step="0.05" />
                <span v-cloak>{{ pitchDisplay }}</span>
              </div>
            </div>
          </div>

          <details>
            <summary>é«˜çº§æ–‡æœ¬æ¸…ç†é€‰é¡¹</summary>
            <div class="checkbox-grid">
              <label class="checkbox-item">
                <input type="checkbox" v-model="form.cleaning.removeMarkdown" @change="saveForm" />
                ç§»é™¤ Markdown
              </label>
              <label class="checkbox-item">
                <input type="checkbox" v-model="form.cleaning.removeEmoji" @change="saveForm" />
                ç§»é™¤ Emoji
              </label>
              <label class="checkbox-item">
                <input type="checkbox" v-model="form.cleaning.removeUrls" @change="saveForm" />
                ç§»é™¤ URL
              </label>
              <label class="checkbox-item">
                <input type="checkbox" v-model="form.cleaning.removeLineBreaks" @change="saveForm" />
                ç§»é™¤æ‰€æœ‰ç©ºç™½/æ¢è¡Œ
              </label>
              <label class="checkbox-item">
                <input type="checkbox" v-model="form.cleaning.removeCitation" @change="saveForm" />
                ç§»é™¤å¼•ç”¨æ ‡è®°æ•°å­—
              </label>
            </div>
            <div class="form-group" style="margin-top: 1rem; margin-bottom: 0">
              <label for="customKeywords">è‡ªå®šä¹‰ç§»é™¤å…³é”®è¯ (é€—å·åˆ†éš”)</label>
              <input type="text" id="customKeywords" v-model="form.cleaning.customKeywords" @input="saveForm"
                placeholder="ä¾‹å¦‚: ABC,XYZ" />
            </div>
          </details>

          <div class="button-group">
            <button class="btn-generate" v-cloak :disabled="isLoading" @click="generateSpeech(false)">
              <span v-if="isLoading && !isStreaming" class="loading"></span>
              {{ isLoading && !isStreaming ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆè¯­éŸ³ (æ ‡å‡†)' }}
            </button>
            <button class="btn-stream" v-cloak :disabled="isLoading" @click="generateSpeech(true)">
              <span v-if="isLoading && isStreaming" class="loading"></span>
              {{ isLoading && isStreaming ? 'æµå¼æ’­æ”¾ä¸­...' : 'ç”Ÿæˆè¯­éŸ³ (æµå¼)' }}
            </button>
          </div>
        </div>

        <div class="tts-result-card">
          <h3><i class="fas fa-play-circle"></i> æ’­æ”¾ç»“æœ</h3>
          
          <div class="status" :class="['status-' + status.type, { show: status.show }]" v-cloak>
            {{ status.message }}
          </div>

          <audio ref="audioPlayer" controls v-show="audioSrc" v-cloak :src="audioSrc" 
                 @loadstart="onAudioLoadStart" @canplay="onAudioCanPlay"></audio>

          <div v-if="showDownloadBtn" class="download-section" v-cloak>
            <button class="btn-download" @click="downloadAudio">
              <span>ğŸ“¥</span> ä¸‹è½½éŸ³é¢‘æ–‡ä»¶
            </button>
          </div>
        </div>
      </div>

      <!-- AIè®¾ç½®å¼¹çª— -->
      <div v-if="showAISettings" class="modal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5><i class="fas fa-robot"></i> AIåŠ©æ‰‹è®¾ç½®</h5>
              <button @click="showAISettings = false" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="aiBaseUrl">AI APIåŸºç¡€åœ°å€:</label>
                <input type="url" id="aiBaseUrl" v-model="aiSettings.baseUrl"
                       placeholder="https://api.openai.com"
                       @blur="onBaseUrlChange"
                       style="font-size: 0.9rem;">
                <div class="help-text">
                  åŸºç¡€URLï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‹¼æ¥è·¯å¾„<br>
                  â€¢ å¯¹è¯æ¥å£ï¼š/v1/chat/completions<br>
                  â€¢ æ¨¡å‹åˆ—è¡¨ï¼š/v1/models
                </div>
              </div>

              <div class="form-group">
                <label for="aiApiKey">APIå¯†é’¥:</label>
                <input type="password" id="aiApiKey" v-model="aiSettings.apiKey"
                       placeholder="sk-..."
                       @blur="onApiKeyChange">
              </div>

              <div class="form-group">
                <div class="label-with-controls">
                  <label for="aiModel">æ¨¡å‹:</label>
                  <button @click="fetchModels"
                          :disabled="isLoadingModels || !aiSettings.baseUrl || !aiSettings.apiKey"
                          class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-sync-alt" :class="{ 'fa-spin': isLoadingModels }"></i>
                    {{ isLoadingModels ? 'è·å–ä¸­...' : 'è·å–æ¨¡å‹' }}
                  </button>
                </div>
                <select id="aiModel" v-model="aiSettings.model" v-if="availableModels.length > 0">
                  <option v-for="model in availableModels" :key="model.id" :value="model.id">
                    {{ model.id }}
                  </option>
                </select>
                <input v-else type="text" id="aiModel" v-model="aiSettings.model"
                       placeholder="gpt-3.5-turbo">
                <div class="help-text" v-if="availableModels.length === 0">
                  è¯·å…ˆé…ç½®APIåœ°å€å’Œå¯†é’¥ï¼Œç„¶åç‚¹å‡»"è·å–æ¨¡å‹"æŒ‰é’®
                </div>
                <div class="help-text" v-else>
                  å·²è·å–åˆ° {{ availableModels.length }} ä¸ªå¯ç”¨æ¨¡å‹
                </div>
              </div>
              
              <div class="form-group">
                <label for="aiSystemPrompt">ç³»ç»Ÿæç¤ºè¯ï¼ˆæ™ºèƒ½ä½“è®¾å®šï¼‰:</label>
                <textarea id="aiSystemPrompt" v-model="aiSettings.systemPrompt" rows="4" 
                          placeholder="ä½ æ˜¯ä¸€ä¸ªå‹å–„ã€æœ‰è¶£çš„AIè¯­éŸ³åŠ©æ‰‹ã€‚è¯·ç”¨ç®€æ´ã€è‡ªç„¶çš„è¯­è¨€å›å¤ç”¨æˆ·ï¼Œä¿æŒå¯¹è¯è½»æ¾æ„‰å¿«ã€‚å›å¤é•¿åº¦æ§åˆ¶åœ¨100å­—ä»¥å†…ï¼Œé™¤éç”¨æˆ·ç‰¹åˆ«è¦æ±‚è¯¦ç»†è§£é‡Šã€‚"></textarea>
                <div class="help-text">è¿™é‡Œè®¾ç½®AIçš„è§’è‰²å’Œè¡Œä¸ºæ–¹å¼ï¼Œç±»ä¼¼æ™ºèƒ½ä½“çš„æç¤ºè¯</div>
              </div>
              
              <div class="form-group">
                <label>åˆ›é€ æ€§ (Temperature): <span>{{ aiSettings.temperature.toFixed(1) }}</span></label>
                <div class="slider-group">
                  <input type="range" v-model.number="aiSettings.temperature" 
                         min="0.1" max="2.0" step="0.1" />
                  <span>{{ aiSettings.temperature.toFixed(1) }}</span>
                </div>
                <div class="help-text">å€¼è¶Šé«˜å›å¤è¶Šæœ‰åˆ›æ„: {{ aiSettings.temperature.toFixed(1) }}</div>
              </div>
              
              <div class="form-group">
                <label for="aiMaxTokens">æœ€å¤§å›å¤é•¿åº¦:</label>
                <input type="number" id="aiMaxTokens" v-model.number="aiSettings.maxTokens"
                       min="50" max="4000" placeholder="150">
                <div class="help-text">æ§åˆ¶AIå›å¤çš„æœ€å¤§é•¿åº¦</div>
              </div>

              <div class="form-group">
                <label>è¿æ¥æµ‹è¯•:</label>
                <div class="test-buttons">
                  <button @click="testConnection"
                          :disabled="!aiSettings.baseUrl || !aiSettings.apiKey || isTestingConnection"
                          class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-plug" :class="{ 'fa-spin': isTestingConnection }"></i>
                    {{ isTestingConnection ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•è¿æ¥' }}
                  </button>
                  <button @click="testModel"
                          :disabled="!aiSettings.baseUrl || !aiSettings.apiKey || !aiSettings.model || isTestingModel"
                          class="btn btn-sm btn-outline-success">
                    <i class="fas fa-robot" :class="{ 'fa-spin': isTestingModel }"></i>
                    {{ isTestingModel ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•æ¨¡å‹' }}
                  </button>
                </div>
                <div class="help-text">æµ‹è¯•APIè¿æ¥å’Œæ¨¡å‹å¯ç”¨æ€§</div>
              </div>
            </div>
            <div class="modal-footer">
              <button @click="showAISettings = false" class="btn btn-secondary">å–æ¶ˆ</button>
              <button @click="saveAISettings" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
            </div>
          </div>
        </div>
      </div>
<!DOCTYPE html>
<html lang="zh-Hans">


  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          title: 'ğŸ™ï¸ AIè¯­éŸ³åŠ©æ‰‹ | æ™ºèƒ½å¯¹è¯+TTSæœåŠ¡ (v4.0)',
          currentMode: 'chat', // å½“å‰æ¨¡å¼ï¼šchat æˆ– tts
          
          // TTS ç›¸å…³æ•°æ®
          isLoading: false,
          isStreaming: false,
          audioSrc: '',
          downloadUrl: '',
          showDownloadBtn: false,
          pauseTime: 1.0,
          config: {
            baseUrl: 'https://ä½ çš„åŸŸå',
            apiKey: 'ä½ çš„å¯†é’¥'
          },
          form: {
            inputText: 'è¯·åœ¨è¿™é‡Œè¾“å…¥æ–‡æœ¬ï¼Œç›®å‰å°½å¯èƒ½ä¸è¦è¶…è¿‡1ç‚¹5ä¸‡å­—æ¯æ¬¡ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚éŸ³è‰²æ˜ å°„å¯ä»¥è‡ªè¡Œä¿®æ”¹workersçš„é…ç½®',
            voice: 'zh-CN-XiaoxiaoNeural',
            speed: 1.0,
            pitch: 1.0,
            cleaning: {
              removeMarkdown: true,
              removeEmoji: true,
              removeUrls: true,
              removeLineBreaks: true,
              removeCitation: true,
              customKeywords: ''
            }
          },
          status: {
            show: false,
            message: '',
            type: 'info'
          },
          
          // AI å¯¹è¯ç›¸å…³æ•°æ®
          chatInput: '',
          chatHistory: [],
          isThinking: false,
          isGeneratingVoice: false,
          currentAudio: null,
          showAISettings: false,
          
          // AI è®¾ç½®
          aiSettings: {
            baseUrl: 'https://api.openai.com',
            apiKey: '',
            model: 'gpt-3.5-turbo',
            systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªå‹å–„ã€æœ‰è¶£çš„AIè¯­éŸ³åŠ©æ‰‹ã€‚è¯·ç”¨ç®€æ´ã€è‡ªç„¶çš„è¯­è¨€å›å¤ç”¨æˆ·ï¼Œä¿æŒå¯¹è¯è½»æ¾æ„‰å¿«ã€‚å›å¤é•¿åº¦æ§åˆ¶åœ¨100å­—ä»¥å†…ï¼Œé™¤éç”¨æˆ·ç‰¹åˆ«è¦æ±‚è¯¦ç»†è§£é‡Šã€‚',
            temperature: 0.7,
            maxTokens: 150
          },

          // å¯ç”¨æ¨¡å‹åˆ—è¡¨
          availableModels: [],
          isLoadingModels: false,

          // è°ƒè¯•ä¿¡æ¯
          showDebugPanel: false,
          debugLogs: [],
          isTestingConnection: false,
          isTestingModel: false,
          
          // èŠå¤©è¯­éŸ³è®¾ç½®
          chatSettings: {
            voice: 'zh-CN-XiaoxiaoNeural',
            speed: 1.0,
            pitch: 1.0,
            autoSpeak: true
          }
        }
      },
      computed: {
        charCount() {
          return this.form.inputText.length;
        },
        speedDisplay() {
          return this.form.speed.toFixed(2);
        },
        pitchDisplay() {
          return this.form.pitch.toFixed(2);
        }
      },
      methods: {
        // æ¨¡å¼åˆ‡æ¢
        switchMode(mode) {
          this.currentMode = mode;
          this.saveSettings();
        },
        
        // AI å¯¹è¯åŠŸèƒ½
        async sendMessage(userMessageParam = null, retryCount = 0) {
          // æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦æ˜¯äº‹ä»¶å¯¹è±¡
          if (userMessageParam && typeof userMessageParam === 'object' && userMessageParam.isTrusted !== undefined) {
            // è¿™æ˜¯ä¸€ä¸ªäº‹ä»¶å¯¹è±¡ï¼Œå¿½ç•¥å®ƒ
            userMessageParam = null;
            retryCount = 0;
          }

          // å¦‚æœæ˜¯é‡è¯•è°ƒç”¨ä¸”ä¼ å…¥äº†å­—ç¬¦ä¸²æ¶ˆæ¯ï¼Œä½¿ç”¨ä¼ å…¥çš„æ¶ˆæ¯ï¼›å¦åˆ™ä»è¾“å…¥æ¡†è·å–
          let userMessage;
          if (userMessageParam && typeof userMessageParam === 'string') {
            userMessage = userMessageParam;
          } else {
            if (!this.chatInput.trim() || this.isThinking) return;
            userMessage = this.chatInput.trim();
            this.chatInput = '';
          }

          // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡å°è¯•æ—¶æ·»åŠ ï¼‰
          if (retryCount === 0) {
            const userMsg = {
              role: 'user',
              content: userMessage
            };
            this.chatHistory.push(userMsg);
            this.saveChatHistory(); // ç«‹å³ä¿å­˜ç”¨æˆ·æ¶ˆæ¯

            // è°ƒè¯•æ—¥å¿—
            this.addDebugLog('info', 'ç”¨æˆ·æ¶ˆæ¯å·²æ·»åŠ ', {
              messageText: userMessage,
              messageLength: userMessage.length,
              historyLength: this.chatHistory.length,
              lastMessageRole: this.chatHistory[this.chatHistory.length - 1].role,
              lastMessageContent: this.chatHistory[this.chatHistory.length - 1].content
            });

            console.log('âœ… ç”¨æˆ·æ¶ˆæ¯å·²æ·»åŠ åˆ°å†å²:', userMsg);
            console.log('ğŸ“ å½“å‰èŠå¤©å†å²é•¿åº¦:', this.chatHistory.length);

            // å¼ºåˆ¶Vueæ›´æ–°DOM
            this.$forceUpdate();
          }

          this.isThinking = true;
          this.scrollToBottom();

          try {
            const aiResponse = await this.callAI(userMessage);

            // æ·»åŠ AIå›å¤
            this.chatHistory.push({
              role: 'assistant',
              content: aiResponse
            });

            this.saveChatHistory();
            this.scrollToBottom();

            // è‡ªåŠ¨æœ—è¯»AIå›å¤
            if (this.chatSettings.autoSpeak) {
              await this.speakText(aiResponse);
            }

          } catch (error) {
            console.error('AIå›å¤å¤±è´¥:', error);

            // å¦‚æœæ˜¯500é”™è¯¯ä¸”æ˜¯ç¬¬ä¸€æ¬¡å¤±è´¥ï¼Œå°è¯•æ¸…ç†å†å²åé‡è¯•
            if (error.message.includes('500') && retryCount === 0 && this.chatHistory.length > 2) {
              this.addDebugLog('warning', 'æ£€æµ‹åˆ°500é”™è¯¯ï¼Œæ¸…ç†å¯¹è¯å†å²åé‡è¯•');
              this.updateStatus('æ£€æµ‹åˆ°æœåŠ¡å™¨é”™è¯¯ï¼Œæ­£åœ¨æ¸…ç†å†å²å¹¶é‡è¯•...', 'warning');

              // æ¸…ç†å¯¹è¯å†å²ä¸­çš„é”™è¯¯æ¶ˆæ¯
              this.cleanChatHistory();

              // å»¶è¿Ÿ1ç§’åé‡è¯•ï¼Œä¼ é€’åŸå§‹ç”¨æˆ·æ¶ˆæ¯
              setTimeout(() => {
                this.sendMessage(userMessage, 1); // ä¼ é€’ç”¨æˆ·æ¶ˆæ¯å’Œé‡è¯•æ ‡è®°
              }, 1000);

              return;
            }

            this.updateStatus('AIå›å¤å¤±è´¥: ' + error.message, 'error');

            this.chatHistory.push({
              role: 'assistant',
              content: 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ã€‚è¯·æ£€æŸ¥AIè®¾ç½®æˆ–ç¨åå†è¯•ã€‚'
            });
            this.saveChatHistory(); // ä¿å­˜é”™è¯¯æ¶ˆæ¯
          } finally {
            this.isThinking = false;
          }
        },
        
        async callAI(message) {
          if (!this.aiSettings.apiKey) {
            throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®AI APIå¯†é’¥');
          }

          if (!this.aiSettings.baseUrl) {
            throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®AI APIåŸºç¡€åœ°å€');
          }

          const messages = [];

          // åªæœ‰å½“ç³»ç»Ÿæç¤ºè¯ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ systemæ¶ˆæ¯
          if (this.aiSettings.systemPrompt && this.aiSettings.systemPrompt.trim()) {
            messages.push({ role: 'system', content: this.aiSettings.systemPrompt.trim() });
          }

          // æ·»åŠ æœ€è¿‘çš„å¯¹è¯å†å²ï¼ˆæœ€å¤š5æ¡ï¼Œå¹¶è¿‡æ»¤é”™è¯¯æ¶ˆæ¯ï¼‰
          const recentHistory = this.chatHistory
            .slice(-10) // å–æœ€è¿‘10æ¡
            .filter(msg => {
              // è¿‡æ»¤æ‰é”™è¯¯æ¶ˆæ¯å’Œç©ºæ¶ˆæ¯
              if (!msg.content || msg.content.trim() === '') return false;
              if (msg.content.includes('æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤')) return false;
              if (msg.content.includes('è¯·æ£€æŸ¥AIè®¾ç½®')) return false;
              if (msg.content.includes('APIè°ƒç”¨å¤±è´¥')) return false;
              return true;
            })
            .slice(-5); // æœ€ç»ˆåªä¿ç•™5æ¡æœ‰æ•ˆå†å²

          messages.push(...recentHistory);

          // æ³¨æ„ï¼šä¸éœ€è¦å†æ¬¡æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼Œå› ä¸ºå®ƒå·²ç»åœ¨recentHistoryä¸­äº†
          // å¦‚æœrecentHistoryä¸ºç©ºï¼ˆæ¯”å¦‚åˆšæ¸…ç©ºå†å²ï¼‰ï¼Œæ‰æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
          if (recentHistory.length === 0 ||
              recentHistory[recentHistory.length - 1].content !== message) {
            messages.push({ role: 'user', content: message });
          }

          // ä¼°ç®—Tokenæ•°é‡ï¼ˆç²—ç•¥ä¼°ç®—ï¼š1ä¸ªä¸­æ–‡å­—ç¬¦â‰ˆ1.5ä¸ªtokenï¼Œ1ä¸ªè‹±æ–‡å•è¯â‰ˆ1.3ä¸ªtokenï¼‰
          const estimatedTokens = messages.reduce((total, msg) => {
            const content = msg.content || '';
            const chineseChars = (content.match(/[\u4e00-\u9fff]/g) || []).length;
            const englishWords = (content.match(/[a-zA-Z]+/g) || []).length;
            const otherChars = content.length - chineseChars - englishWords;
            return total + Math.ceil(chineseChars * 1.5 + englishWords * 1.3 + otherChars * 0.5);
          }, 0);

          // è®°å½•å®é™…ä½¿ç”¨çš„æ¶ˆæ¯æ•°é‡å’ŒTokenä¼°ç®—
          this.addDebugLog('info', `æ„å»ºæ¶ˆæ¯åˆ—è¡¨å®Œæˆï¼Œå…±${messages.length}æ¡æ¶ˆæ¯`, {
            systemPrompt: !!this.aiSettings.systemPrompt,
            historyCount: recentHistory.length,
            totalMessages: messages.length,
            estimatedTokens: estimatedTokens,
            maxTokens: this.aiSettings.maxTokens,
            messageRoles: messages.map(m => m.role),
            lastUserMessage: message
          });

          // å¦‚æœä¼°ç®—Tokenæ•°è¿‡å¤šï¼Œè­¦å‘Šç”¨æˆ·
          if (estimatedTokens > this.aiSettings.maxTokens * 0.7) {
            this.addDebugLog('warning', `Tokenä½¿ç”¨é‡è¾ƒé«˜ (${estimatedTokens}/${this.aiSettings.maxTokens})ï¼Œå»ºè®®æ¸…ç†å¯¹è¯å†å²`);
          }

          // æ„å»ºå®Œæ•´çš„API URL
          const apiUrl = this.aiSettings.baseUrl.replace(/\/$/, '') + '/v1/chat/completions';

          // æ„å»ºè¯·æ±‚ä½“
          const requestBody = {
            model: this.aiSettings.model,
            messages: messages,
            temperature: this.aiSettings.temperature,
            max_tokens: this.aiSettings.maxTokens
          };

          // è°ƒè¯•ä¿¡æ¯
          this.addDebugLog('info', 'AI APIè°ƒç”¨å¼€å§‹', {
            url: apiUrl,
            model: this.aiSettings.model,
            requestBody: requestBody,
            apiKeyPrefix: this.aiSettings.apiKey.substring(0, 10) + '...'
          });

          console.log('ğŸš€ AI APIè°ƒç”¨è¯¦æƒ…:');
          console.log('ğŸ“ URL:', apiUrl);
          console.log('ğŸ¤– æ¨¡å‹:', this.aiSettings.model);
          console.log('ğŸ“ è¯·æ±‚ä½“:', JSON.stringify(requestBody, null, 2));
          console.log('ğŸ”‘ APIå¯†é’¥å‰ç¼€:', this.aiSettings.apiKey.substring(0, 10) + '...');

          // æ£€æŸ¥æ¶ˆæ¯æ ¼å¼
          console.log('ğŸ“‹ æ¶ˆæ¯è¯¦æƒ…:');
          messages.forEach((msg, index) => {
            console.log(`  ${index + 1}. ${msg.role}: ${msg.content.substring(0, 50)}${msg.content.length > 50 ? '...' : ''}`);
          });

          let response;
          try {
            response = await fetch(apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.aiSettings.apiKey}`,
                'User-Agent': 'AI-Voice-Assistant/1.0'
              },
              body: JSON.stringify(requestBody)
            });

            console.log('ğŸ“¡ å“åº”çŠ¶æ€:', response.status, response.statusText);
            console.log('ğŸ“‹ å“åº”å¤´:', Object.fromEntries(response.headers.entries()));

            this.addDebugLog('info', `æ”¶åˆ°å“åº”: ${response.status} ${response.statusText}`, {
              status: response.status,
              statusText: response.statusText,
              headers: Object.fromEntries(response.headers.entries())
            });

          } catch (networkError) {
            console.error('ğŸŒ ç½‘ç»œé”™è¯¯:', networkError);
            this.addDebugLog('error', 'ç½‘ç»œè¯·æ±‚å¤±è´¥', { error: networkError.message });
            throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${networkError.message}`);
          }

          if (!response.ok) {
            let errorData;
            let errorText;

            try {
              errorText = await response.text();
              console.log('âŒ é”™è¯¯å“åº”åŸæ–‡:', errorText);

              // å°è¯•è§£æä¸ºJSON
              try {
                errorData = JSON.parse(errorText);
              } catch (parseError) {
                console.warn('âš ï¸ æ— æ³•è§£æé”™è¯¯å“åº”ä¸ºJSON:', parseError);
                errorData = { message: errorText };
              }
            } catch (readError) {
              console.error('ğŸ“– è¯»å–é”™è¯¯å“åº”å¤±è´¥:', readError);
              errorData = { message: 'æ— æ³•è¯»å–é”™è¯¯ä¿¡æ¯' };
            }

            const errorMessage = errorData.error?.message ||
                               errorData.message ||
                               errorText ||
                               `HTTP ${response.status}: ${response.statusText}`;

            console.error('ğŸ’¥ APIè°ƒç”¨å¤±è´¥:', errorMessage);
            this.addDebugLog('error', 'APIè°ƒç”¨å¤±è´¥', {
              status: response.status,
              statusText: response.statusText,
              errorData: errorData,
              errorText: errorText
            });
            throw new Error(errorMessage);
          }

          let data;
          try {
            const responseText = await response.text();
            console.log('âœ… æˆåŠŸå“åº”åŸæ–‡:', responseText);

            data = JSON.parse(responseText);
            console.log('ğŸ“Š è§£æåçš„å“åº”æ•°æ®:', data);

          } catch (parseError) {
            console.error('ğŸ”§ è§£æå“åº”å¤±è´¥:', parseError);
            throw new Error('APIå“åº”æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æ');
          }

          if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            console.error('ğŸš« å“åº”æ•°æ®ç»“æ„å¼‚å¸¸:', data);
            throw new Error('APIå“åº”æ•°æ®ç»“æ„å¼‚å¸¸');
          }

          const aiResponse = data.choices[0].message.content;
          console.log('ğŸ¯ AIå›å¤å†…å®¹:', aiResponse);

          this.addDebugLog('success', 'AIå›å¤æˆåŠŸ', {
            response: aiResponse,
            model: this.aiSettings.model,
            tokensUsed: data.usage || 'æœªçŸ¥'
          });

          return aiResponse;
        },
        
        // è¯­éŸ³æœ—è¯»åŠŸèƒ½
        async speakText(text) {
          if (this.isGeneratingVoice) return;
          
          try {
            this.isGeneratingVoice = true;
            
            const requestBody = {
              voice: this.chatSettings.voice,
              input: text,
              speed: this.chatSettings.speed,
              pitch: this.chatSettings.pitch,
              stream: false
            };
            
            const baseUrl = this.config.baseUrl.trim();
            const apiKey = this.config.apiKey.trim();
            
            if (!baseUrl || !apiKey) {
              throw new Error('è¯·å…ˆé…ç½®TTS API');
            }
            
            const response = await fetch(baseUrl + '/v1/audio/speech', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + apiKey,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(requestBody),
            });
            
            if (!response.ok) {
              throw new Error(`è¯­éŸ³ç”Ÿæˆå¤±è´¥: ${response.status}`);
            }
            
            const blob = await response.blob();
            const audioUrl = URL.createObjectURL(blob);
            
            // æ’­æ”¾éŸ³é¢‘
            if (this.currentAudio) {
              this.currentAudio.pause();
              URL.revokeObjectURL(this.currentAudio.src);
            }
            
            this.currentAudio = new Audio(audioUrl);
            await this.currentAudio.play();
            
          } catch (error) {
            console.error('è¯­éŸ³æœ—è¯»å¤±è´¥:', error);
            this.updateStatus('è¯­éŸ³æœ—è¯»å¤±è´¥: ' + error.message, 'error');
          } finally {
            this.isGeneratingVoice = false;
          }
        },
        
        // éŸ³é¢‘æ§åˆ¶
        playAudio() {
          if (this.currentAudio && this.currentAudio.paused) {
            this.currentAudio.play();
          }
        },
        
        pauseAudio() {
          if (this.currentAudio && !this.currentAudio.paused) {
            this.currentAudio.pause();
          }
        },
        
        stopAudio() {
          if (this.currentAudio) {
            this.currentAudio.pause();
            this.currentAudio.currentTime = 0;
          }
        },
        
        replayAudio() {
          if (this.currentAudio) {
            this.currentAudio.currentTime = 0;
            this.currentAudio.play();
          }
        },
        
        // æ¸…ç©ºå¯¹è¯
        clearChat() {
          if (confirm('ç¡®å®šè¦æ¸…ç©ºå¯¹è¯å†å²å—ï¼Ÿ')) {
            this.chatHistory = [];
            this.saveChatHistory();
            this.addDebugLog('info', 'å¯¹è¯å†å²å·²æ¸…ç©º');
            this.updateStatus('å¯¹è¯å†å²å·²æ¸…ç©º', 'success');
          }
        },

        // æ¸…ç†å¯¹è¯å†å²ä¸­çš„é”™è¯¯æ¶ˆæ¯
        cleanChatHistory() {
          const originalCount = this.chatHistory.length;
          this.chatHistory = this.chatHistory.filter(msg => {
            if (!msg.content || msg.content.trim() === '') return false;
            if (msg.content.includes('æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤')) return false;
            if (msg.content.includes('è¯·æ£€æŸ¥AIè®¾ç½®')) return false;
            if (msg.content.includes('APIè°ƒç”¨å¤±è´¥')) return false;
            return true;
          });

          const cleanedCount = originalCount - this.chatHistory.length;
          if (cleanedCount > 0) {
            this.saveChatHistory();
            this.addDebugLog('success', `æ¸…ç†å¯¹è¯å†å²å®Œæˆï¼Œç§»é™¤${cleanedCount}æ¡é”™è¯¯æ¶ˆæ¯`);
            this.updateStatus(`å·²æ¸…ç†${cleanedCount}æ¡é”™è¯¯æ¶ˆæ¯`, 'success');
          } else {
            this.addDebugLog('info', 'å¯¹è¯å†å²æ— éœ€æ¸…ç†');
            this.updateStatus('å¯¹è¯å†å²æ— éœ€æ¸…ç†', 'info');
          }
        },
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        scrollToBottom() {
          setTimeout(() => {
            const chatMessages = document.querySelector('.chat-messages');
            if (chatMessages) {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
          }, 100);
        },
        
        // AIè®¾ç½®ç®¡ç†
        saveAISettings() {
          this.saveSettings();
          this.showAISettings = false;
          this.updateStatus('AIè®¾ç½®å·²ä¿å­˜', 'success');
        },

        // è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
        async fetchModels() {
          if (!this.aiSettings.baseUrl || !this.aiSettings.apiKey) {
            this.updateStatus('è¯·å…ˆé…ç½®APIåœ°å€å’Œå¯†é’¥', 'error');
            return;
          }

          this.isLoadingModels = true;

          try {
            const modelsUrl = this.aiSettings.baseUrl.replace(/\/$/, '') + '/v1/models';

            const response = await fetch(modelsUrl, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${this.aiSettings.apiKey}`,
                'Content-Type': 'application/json'
              }
            });

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.data && Array.isArray(data.data)) {
              // è¿‡æ»¤å’Œæ’åºæ¨¡å‹
              this.availableModels = data.data
                .filter(model => model.id && typeof model.id === 'string')
                .sort((a, b) => a.id.localeCompare(b.id));

              this.updateStatus(`æˆåŠŸè·å– ${this.availableModels.length} ä¸ªæ¨¡å‹`, 'success');

              // å¦‚æœå½“å‰é€‰æ‹©çš„æ¨¡å‹ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨æ¨¡å‹
              if (this.availableModels.length > 0) {
                const currentModelExists = this.availableModels.some(model => model.id === this.aiSettings.model);
                if (!currentModelExists) {
                  this.aiSettings.model = this.availableModels[0].id;
                }
              }
            } else {
              throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
            }
          } catch (error) {
            console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
            this.updateStatus('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            this.availableModels = [];
          } finally {
            this.isLoadingModels = false;
          }
        },

        // åŸºç¡€URLå˜åŒ–æ—¶çš„å¤„ç†
        onBaseUrlChange() {
          // æ¸…ç©ºæ¨¡å‹åˆ—è¡¨ï¼Œéœ€è¦é‡æ–°è·å–
          this.availableModels = [];
        },

        // APIå¯†é’¥å˜åŒ–æ—¶çš„å¤„ç†
        onApiKeyChange() {
          // æ¸…ç©ºæ¨¡å‹åˆ—è¡¨ï¼Œéœ€è¦é‡æ–°è·å–
          this.availableModels = [];
        },

        // è°ƒè¯•æ—¥å¿—ç®¡ç†
        addDebugLog(type, message, data = null) {
          const log = {
            time: new Date().toLocaleTimeString(),
            type: type, // info, success, error, warning
            message: message,
            data: data ? JSON.stringify(data, null, 2) : null
          };

          this.debugLogs.unshift(log);

          // é™åˆ¶æ—¥å¿—æ•°é‡ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤š
          if (this.debugLogs.length > 50) {
            this.debugLogs = this.debugLogs.slice(0, 50);
          }

          // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
          setTimeout(() => {
            const debugLogsElement = document.querySelector('.debug-logs');
            if (debugLogsElement) {
              debugLogsElement.scrollTop = 0;
            }
          }, 100);
        },

        clearDebugLogs() {
          this.debugLogs = [];
          this.addDebugLog('info', 'è°ƒè¯•æ—¥å¿—å·²æ¸…ç©º');
        },

        exportDebugLogs() {
          const logs = this.debugLogs.map(log => ({
            time: log.time,
            type: log.type,
            message: log.message,
            data: log.data
          }));

          const dataStr = JSON.stringify(logs, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);

          const link = document.createElement('a');
          link.href = url;
          link.download = `ai-debug-logs-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          URL.revokeObjectURL(url);
          this.addDebugLog('success', 'è°ƒè¯•æ—¥å¿—å·²å¯¼å‡º');
        },

        // æµ‹è¯•APIè¿æ¥
        async testConnection() {
          if (!this.aiSettings.baseUrl || !this.aiSettings.apiKey) {
            this.updateStatus('è¯·å…ˆé…ç½®APIåœ°å€å’Œå¯†é’¥', 'error');
            return;
          }

          this.isTestingConnection = true;
          this.addDebugLog('info', 'å¼€å§‹æµ‹è¯•APIè¿æ¥');

          try {
            const modelsUrl = this.aiSettings.baseUrl.replace(/\/$/, '') + '/v1/models';

            const response = await fetch(modelsUrl, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${this.aiSettings.apiKey}`,
                'Content-Type': 'application/json'
              }
            });

            if (response.ok) {
              this.addDebugLog('success', 'APIè¿æ¥æµ‹è¯•æˆåŠŸ', {
                status: response.status,
                url: modelsUrl
              });
              this.updateStatus('APIè¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
            } else {
              const errorText = await response.text();
              this.addDebugLog('error', 'APIè¿æ¥æµ‹è¯•å¤±è´¥', {
                status: response.status,
                statusText: response.statusText,
                error: errorText
              });
              this.updateStatus(`APIè¿æ¥æµ‹è¯•å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
            }
          } catch (error) {
            this.addDebugLog('error', 'APIè¿æ¥æµ‹è¯•å¼‚å¸¸', { error: error.message });
            this.updateStatus(`è¿æ¥æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
          } finally {
            this.isTestingConnection = false;
          }
        },

        // æµ‹è¯•æ¨¡å‹è°ƒç”¨
        async testModel() {
          if (!this.aiSettings.baseUrl || !this.aiSettings.apiKey || !this.aiSettings.model) {
            this.updateStatus('è¯·å…ˆé…ç½®å®Œæ•´çš„APIä¿¡æ¯', 'error');
            return;
          }

          this.isTestingModel = true;
          this.addDebugLog('info', `å¼€å§‹æµ‹è¯•æ¨¡å‹: ${this.aiSettings.model}`);

          try {
            const testMessage = 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªè¿æ¥æµ‹è¯•ï¼Œè¯·ç®€å•å›å¤"æµ‹è¯•æˆåŠŸ"ã€‚';
            const response = await this.callAI(testMessage);

            this.addDebugLog('success', 'æ¨¡å‹æµ‹è¯•æˆåŠŸ', {
              model: this.aiSettings.model,
              testMessage: testMessage,
              response: response
            });
            this.updateStatus(`æ¨¡å‹ ${this.aiSettings.model} æµ‹è¯•æˆåŠŸï¼`, 'success');

          } catch (error) {
            this.addDebugLog('error', 'æ¨¡å‹æµ‹è¯•å¤±è´¥', {
              model: this.aiSettings.model,
              error: error.message
            });
            this.updateStatus(`æ¨¡å‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          } finally {
            this.isTestingModel = false;
          }
        },
        
        // æ•°æ®æŒä¹…åŒ–
        saveSettings() {
          try {
            const settings = {
              currentMode: this.currentMode,
              aiSettings: this.aiSettings,
              chatSettings: this.chatSettings,
              config: this.config,
              form: this.form,
              availableModels: this.availableModels
            };
            localStorage.setItem('ai_tts_settings', JSON.stringify(settings));
          } catch (e) {
            console.warn('ä¿å­˜è®¾ç½®å¤±è´¥:', e);
          }
        },

        loadSettings() {
          try {
            const saved = localStorage.getItem('ai_tts_settings');
            if (saved) {
              const settings = JSON.parse(saved);
              this.currentMode = settings.currentMode || 'chat';
              this.aiSettings = { ...this.aiSettings, ...settings.aiSettings };
              this.chatSettings = { ...this.chatSettings, ...settings.chatSettings };
              this.config = { ...this.config, ...settings.config };
              this.form = { ...this.form, ...settings.form };
              this.availableModels = settings.availableModels || [];

              // å…¼å®¹æ—§ç‰ˆæœ¬çš„apiUrlè®¾ç½®
              if (settings.aiSettings && settings.aiSettings.apiUrl && !settings.aiSettings.baseUrl) {
                // ä»å®Œæ•´URLä¸­æå–åŸºç¡€URL
                const url = settings.aiSettings.apiUrl;
                if (url.includes('/v1/chat/completions')) {
                  this.aiSettings.baseUrl = url.replace('/v1/chat/completions', '');
                } else if (url.includes('/v1/')) {
                  this.aiSettings.baseUrl = url.substring(0, url.indexOf('/v1/'));
                } else {
                  this.aiSettings.baseUrl = url;
                }
              }
            }
          } catch (e) {
            console.warn('åŠ è½½è®¾ç½®å¤±è´¥:', e);
          }
        },
        
        saveChatHistory() {
          try {
            localStorage.setItem('chat_history', JSON.stringify(this.chatHistory));
          } catch (e) {
            console.warn('ä¿å­˜èŠå¤©å†å²å¤±è´¥:', e);
          }
        },
        
        loadChatHistory() {
          try {
            const saved = localStorage.getItem('chat_history');
            if (saved) {
              this.chatHistory = JSON.parse(saved);
            }
          } catch (e) {
            console.warn('åŠ è½½èŠå¤©å†å²å¤±è´¥:', e);
          }
        },
        
        // åŸæœ‰çš„TTSåŠŸèƒ½ä¿æŒä¸å˜
        loadConfig() {
          try {
            const saved = localStorage.getItem('tts_config');
            if (saved) {
              this.config = { ...this.config, ...JSON.parse(saved) };
              if (this.config.baseUrl.endsWith('/')) {
                this.config.baseUrl = this.config.baseUrl.slice(0, -1);
              }
            }
          } catch (e) {
            console.warn('Failed to load config from localStorage:', e);
          }
        },
        saveConfig() {
          try {
            localStorage.setItem('tts_config', JSON.stringify(this.config));
          } catch (e) {
            console.warn('Failed to save config to localStorage:', e);
          }
        },
        loadForm() {
          try {
            const saved = localStorage.getItem('tts_form');
            if (saved) {
              this.form = { ...this.form, ...JSON.parse(saved) };
            }
          } catch (e) {
            console.warn('Failed to load form from localStorage:', e);
          }
        },
        saveForm() {
          try {
            localStorage.setItem('tts_form', JSON.stringify(this.form));
          } catch (e) {
            console.warn('Failed to save form to localStorage:', e);
          }
        },
        clearText() {
          this.form.inputText = '';
          this.saveForm();
        },
        downloadAudio() {
          if (this.downloadUrl) {
            const link = document.createElement('a');
            link.href = this.downloadUrl;
            let timeString = (new Date().toLocaleString() + '-').replace(/[\/\:]/g, '-').replace(/\s/g, '_').replace(/[-_](\d)[-_]/g, '-0$1-').slice(0, -1);
            link.download = 'tts-audio-' + timeString + '.mp3';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        },
        updateStatus(message, type = 'info') {
          this.status = {
            show: true,
            message,
            type
          };
        },
        hideStatus() {
          this.status.show = false;
        },
        getRequestBody() {
          return {
                voice: this.form.voice,
            input: this.form.inputText.trim(),
            speed: this.form.speed,
            pitch: this.form.pitch,
            cleaning_options: {
              remove_markdown: this.form.cleaning.removeMarkdown,
              remove_emoji: this.form.cleaning.removeEmoji,
              remove_urls: this.form.cleaning.removeUrls,
              remove_line_breaks: this.form.cleaning.removeLineBreaks,
              remove_citation_numbers: this.form.cleaning.removeCitation,
              custom_keywords: this.form.cleaning.customKeywords,
            },
          };
        },
        async generateSpeech(isStream) {
          const baseUrl = this.config.baseUrl.trim(); // å»é™¤æœ«å°¾çš„æ–œæ 
          const apiKey = this.config.apiKey.trim();
          const text = this.form.inputText.trim();

          if (!baseUrl || !apiKey || !text) {
            this.updateStatus('è¯·å¡«å†™ API é…ç½®å’Œè¾“å…¥æ–‡æœ¬', 'error');
            return;
          }

          const requestBody = this.getRequestBody();
          requestBody.stream = isStream;

          this.isLoading = true;
          this.isStreaming = isStream;
          this.audioSrc = '';
          this.showDownloadBtn = false; // é‡ç½®ä¸‹è½½æŒ‰é’®çŠ¶æ€
          if (this.downloadUrl) {
            URL.revokeObjectURL(this.downloadUrl); // æ¸…ç†ä¹‹å‰çš„ä¸‹è½½é“¾æ¥
            this.downloadUrl = '';
          }
          this.updateStatus('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...', 'info');

          try {
            if (isStream) {
              await this.playStreamWithMSE(baseUrl, apiKey, requestBody);
            } else {
              await this.playStandard(baseUrl, apiKey, requestBody);
            }
          } catch (error) {
            console.error('Error generating speech:', error);
            this.updateStatus('é”™è¯¯: ' + error.message, 'error');
          } finally {
            this.isLoading = false;
            this.isStreaming = false;
          }
        },
        async playStandard(baseUrl, apiKey, body) {
          const response = await fetch(baseUrl + '/v1/audio/speech', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + apiKey,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error?.message ||
              'HTTP error! status: ' + response.status
            );
          }

          const blob = await response.blob();
          this.audioSrc = URL.createObjectURL(blob);
          this.downloadUrl = this.audioSrc; // éæµå¼æ¨¡å¼ç›´æ¥ä½¿ç”¨ç›¸åŒçš„URL
          this.showDownloadBtn = true;
          this.updateStatus('æ’­æ”¾ä¸­...', 'success');

          // è‡ªåŠ¨æ’­æ”¾
          this.$nextTick(() => {
            this.$refs.audioPlayer.play().catch(e =>
              console.warn('Autoplay was prevented:', e)
            );
          });
        },
        async playStreamWithMSE(baseUrl, apiKey, body) {
          const mediaSource = new MediaSource();
          this.audioSrc = URL.createObjectURL(mediaSource);

          // ç”¨äºæ”¶é›†éŸ³é¢‘æ•°æ®çš„æ•°ç»„
          const audioChunks = [];

          return new Promise((resolve, reject) => {
            mediaSource.addEventListener('sourceopen', async () => {
              URL.revokeObjectURL(this.audioSrc);
              const sourceBuffer = mediaSource.addSourceBuffer('audio/mpeg');

              try {
                const response = await fetch(baseUrl + '/v1/audio/speech', {
                  method: 'POST',
                  headers: {
                    'Authorization': 'Bearer ' + apiKey,
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(body),
                });

                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(
                    errorData.error?.message ||
                    'HTTP error! status: ' + response.status
                  );
                }

                this.updateStatus('å·²è¿æ¥ï¼Œæ¥æ”¶æ•°æ®ä¸­...', 'info');

                // è‡ªåŠ¨æ’­æ”¾
                this.$nextTick(() => {
                  this.$refs.audioPlayer.play().catch(e =>
                    console.warn('Autoplay was prevented:', e)
                  );
                });

                const reader = response.body.getReader();

                const pump = async () => {
                  const { done, value } = await reader.read();

                  if (done) {
                    if (mediaSource.readyState === 'open' && !sourceBuffer.updating) {
                      mediaSource.endOfStream();
                    }

                    // åˆ›å»ºå®Œæ•´çš„éŸ³é¢‘æ–‡ä»¶ç”¨äºä¸‹è½½
                    const completeAudioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                    this.downloadUrl = URL.createObjectURL(completeAudioBlob);
                    this.showDownloadBtn = true;

                    this.updateStatus('æ’­æ”¾å®Œæ¯•ï¼å¯ç‚¹å‡»ä¸‹è½½æŒ‰é’®ä¿å­˜éŸ³é¢‘', 'success');
                    resolve();
                    return;
                  }

                  // æ”¶é›†éŸ³é¢‘æ•°æ®å—
                  audioChunks.push(value.slice()); // ä½¿ç”¨slice()åˆ›å»ºå‰¯æœ¬

                  if (sourceBuffer.updating) {
                    await new Promise(resolve =>
                      sourceBuffer.addEventListener('updateend', resolve, { once: true })
                    );
                  }

                  sourceBuffer.appendBuffer(value);
                  this.updateStatus('æ­£åœ¨æµå¼æ’­æ”¾...', 'success');
                };

                sourceBuffer.addEventListener('updateend', pump);
                await pump();
              } catch (error) {
                console.error('Error in MSE streaming:', error);
                this.updateStatus('é”™è¯¯: ' + error.message, 'error');
                if (mediaSource.readyState === 'open') {
                  try {
                    mediaSource.endOfStream();
                  } catch (e) { }
                }
                reject(error);
              }
            }, { once: true });
          });
        },
        onAudioLoadStart() {
          console.log('Audio loading started');
        },
        onAudioCanPlay() {
          console.log('Audio can play');
        },
        // æ’å…¥åœé¡¿æ ‡ç­¾
        insertPause() {
          const textarea = this.$refs.textareaRef;
          if (!textarea) return;
          if (!this.pauseTime || this.pauseTime <= 0 || this.pauseTime > 100) {
            window.alert('åœé¡¿æ—¶é—´å¿…é¡»åœ¨ 0.01 åˆ° 100 ç§’ä¹‹é—´', 'error');
            return;
          }

          const start = textarea.selectionStart;
          const end = textarea.selectionEnd;
          const breakTag = '<break time="' + this.pauseTime + 's"/>';

          const newText = this.form.inputText.slice(0, start) +
            breakTag +
            this.form.inputText.slice(end);

          this.form.inputText = newText;

          // ä¿æŒå…‰æ ‡ä½ç½®
          this.$nextTick(() => {
            const newPos = start + breakTag.length;
            textarea.focus();
            textarea.setSelectionRange(newPos, newPos);
          });
        }
      },
      mounted() {
        this.loadConfig();
        this.loadForm();
        this.loadSettings();
        this.loadChatHistory();

        // æ·»åŠ åˆå§‹è°ƒè¯•æ—¥å¿—
        this.addDebugLog('info', 'ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', {
          version: '1.0.0',
          timestamp: new Date().toISOString(),
          baseUrl: this.aiSettings.baseUrl,
          model: this.aiSettings.model
        });
      },
      beforeUnmount() {
        // æ¸…ç†URLå¯¹è±¡ï¼Œé¿å…å†…å­˜æ³„æ¼
        if (this.audioSrc) {
          URL.revokeObjectURL(this.audioSrc);
        }
        if (this.downloadUrl && this.downloadUrl !== this.audioSrc) {
          URL.revokeObjectURL(this.downloadUrl);
        }
      }
    }).mount('#app');
  </script>
</body>

</html>